'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _chai = require('chai');

var _chai2 = _interopRequireDefault(_chai);

var _chaiAsPromised = require('chai-as-promised');

var _chaiAsPromised2 = _interopRequireDefault(_chaiAsPromised);

var _appiumAdb = require('appium-adb');

var _appiumAdb2 = _interopRequireDefault(_appiumAdb);

var _desired = require('./desired');

var _helpersSession = require('./helpers/session');

_chai2['default'].should();
_chai2['default'].use(_chaiAsPromised2['default']);

var APIDEMOS_PACKAGE = 'io.appium.android.apis';

function killServer(adbPort) {
  var adb;
  return _regeneratorRuntime.async(function killServer$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(_appiumAdb2['default'].createADB({ adbPort: adbPort }));

      case 2:
        adb = context$1$0.sent;
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(adb.killServer());

      case 5:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

describe('createSession', function () {
  var driver = undefined;
  before(function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(killServer(5037));

        case 2:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this);
  });

  describe('default adb port', function () {
    var _this = this;

    afterEach(function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            if (!driver) {
              context$3$0.next = 3;
              break;
            }

            context$3$0.next = 3;
            return _regeneratorRuntime.awrap(driver.quit());

          case 3:
            driver = null;

          case 4:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });

    it('should start android session focusing on default pkg and act', function callee$2$0() {
      var appPackage, appActivity;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap((0, _helpersSession.initDriver)(_desired.APIDEMOS_CAPS));

          case 2:
            driver = context$3$0.sent;
            context$3$0.next = 5;
            return _regeneratorRuntime.awrap(driver.getCurrentPackage());

          case 5:
            appPackage = context$3$0.sent;
            context$3$0.next = 8;
            return _regeneratorRuntime.awrap(driver.getCurrentDeviceActivity());

          case 8:
            appActivity = context$3$0.sent;

            appPackage.should.equal('io.appium.android.apis');
            appActivity.should.equal('.ApiDemos');

          case 11:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
    it('should start android session focusing on custom pkg and act', function callee$2$0() {
      var caps, appPackage, appActivity;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            caps = _Object$assign({}, _desired.APIDEMOS_CAPS, {
              appPackage: 'io.appium.android.apis',
              appActivity: '.view.SplitTouchView'
            });
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap((0, _helpersSession.initDriver)(caps));

          case 3:
            driver = context$3$0.sent;
            context$3$0.next = 6;
            return _regeneratorRuntime.awrap(driver.getCurrentPackage());

          case 6:
            appPackage = context$3$0.sent;
            context$3$0.next = 9;
            return _regeneratorRuntime.awrap(driver.getCurrentDeviceActivity());

          case 9:
            appActivity = context$3$0.sent;

            appPackage.should.equal(caps.appPackage);
            appActivity.should.equal(caps.appActivity);

          case 12:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
    it('should error out for not apk extension', function callee$2$0() {
      var caps;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            caps = _Object$assign({}, _desired.APIDEMOS_CAPS, {
              app: 'foo',
              appPackage: 'io.appium.android.apis',
              appActivity: '.view.SplitTouchView'
            });
            context$3$0.prev = 1;
            context$3$0.next = 4;
            return _regeneratorRuntime.awrap((0, _helpersSession.initDriver)(caps));

          case 4:
            throw new Error('Call to \'initDriver\' should not have succeeded');

          case 7:
            context$3$0.prev = 7;
            context$3$0.t0 = context$3$0['catch'](1);

            context$3$0.t0.data.should.match(/New app path foo did not have extension \.apk/);

          case 10:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this, [[1, 7]]);
    });
    it('should error out for invalid app path', function callee$2$0() {
      var caps;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            caps = _Object$assign({}, _desired.APIDEMOS_CAPS, {
              app: 'foo.apk',
              appPackage: 'io.appium.android.apis',
              appActivity: '.view.SplitTouchView'
            });
            context$3$0.prev = 1;
            context$3$0.next = 4;
            return _regeneratorRuntime.awrap((0, _helpersSession.initDriver)(caps));

          case 4:
            throw new Error('Call to \'initDriver\' should not have succeeded');

          case 7:
            context$3$0.prev = 7;
            context$3$0.t0 = context$3$0['catch'](1);

            context$3$0.t0.data.should.match(/Could not find/);

          case 10:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this, [[1, 7]]);
    });
    it('should get device model, manufacturer and screen size in session details', function callee$2$0() {
      var caps, serverCaps;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            caps = _Object$assign({}, _desired.APIDEMOS_CAPS, {
              appPackage: 'io.appium.android.apis',
              appActivity: '.view.SplitTouchView'
            });
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap((0, _helpersSession.initDriver)(caps));

          case 3:
            driver = context$3$0.sent;
            context$3$0.next = 6;
            return _regeneratorRuntime.awrap(driver.sessionCapabilities());

          case 6:
            serverCaps = context$3$0.sent;

            serverCaps.deviceScreenSize.should.exist;
            serverCaps.deviceModel.should.exist;
            serverCaps.deviceManufacturer.should.exist;

          case 10:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
  });

  describe('custom adb port', function () {
    var _this2 = this;

    // Don't do these tests on TestObject. Cannot use TestObject's ADB.
    if (process.env.TESTOBJECT_E2E_TESTS) {
      return;
    }

    var adbPort = 5042;
    var driver = undefined;

    before(function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(killServer(5037));

          case 2:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });
    afterEach(function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(driver.quit());

          case 2:
            context$3$0.next = 4;
            return _regeneratorRuntime.awrap(killServer(adbPort));

          case 4:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });

    it('should start android session with a custom adb port', function callee$2$0() {
      var caps, appPackage, appActivity;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            caps = _Object$assign({}, _desired.APIDEMOS_CAPS, {
              adbPort: adbPort
            });
            context$3$0.next = 3;
            return _regeneratorRuntime.awrap((0, _helpersSession.initDriver)(caps, adbPort));

          case 3:
            driver = context$3$0.sent;
            context$3$0.next = 6;
            return _regeneratorRuntime.awrap(driver.getCurrentPackage());

          case 6:
            appPackage = context$3$0.sent;
            context$3$0.next = 9;
            return _regeneratorRuntime.awrap(driver.getCurrentDeviceActivity());

          case 9:
            appActivity = context$3$0.sent;

            appPackage.should.equal('io.appium.android.apis');
            appActivity.should.equal('.ApiDemos');

          case 12:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this2);
    });
  });
});

describe('close', function () {
  var _this3 = this;

  it('should close application', function callee$1$0() {
    var driver, appPackage;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap((0, _helpersSession.initDriver)(_desired.APIDEMOS_CAPS));

        case 2:
          driver = context$2$0.sent;
          context$2$0.next = 5;
          return _regeneratorRuntime.awrap(driver.closeApp());

        case 5:
          context$2$0.next = 7;
          return _regeneratorRuntime.awrap(driver.getCurrentPackage());

        case 7:
          appPackage = context$2$0.sent;

          if (appPackage) {
            appPackage.should.not.equal(APIDEMOS_PACKAGE);
          }

        case 9:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this3);
  });
});
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvZnVuY3Rpb25hbC9kcml2ZXItZTJlLXNwZWNzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O29CQUFpQixNQUFNOzs7OzhCQUNJLGtCQUFrQjs7Ozt5QkFDN0IsWUFBWTs7Ozt1QkFDRSxXQUFXOzs4QkFDZCxtQkFBbUI7O0FBRTlDLGtCQUFLLE1BQU0sRUFBRSxDQUFDO0FBQ2Qsa0JBQUssR0FBRyw2QkFBZ0IsQ0FBQzs7QUFFekIsSUFBTSxnQkFBZ0IsR0FBRyx3QkFBd0IsQ0FBQzs7QUFFbEQsU0FBZSxVQUFVLENBQUUsT0FBTztNQUM1QixHQUFHOzs7Ozt5Q0FBUyx1QkFBSSxTQUFTLENBQUMsRUFBQyxPQUFPLEVBQVAsT0FBTyxFQUFDLENBQUM7OztBQUFwQyxXQUFHOzt5Q0FDRCxHQUFHLENBQUMsVUFBVSxFQUFFOzs7Ozs7O0NBQ3ZCOztBQUVELFFBQVEsQ0FBQyxlQUFlLEVBQUUsWUFBWTtBQUNwQyxNQUFJLE1BQU0sWUFBQSxDQUFDO0FBQ1gsUUFBTSxDQUFDOzs7OzsyQ0FDQyxVQUFVLENBQUMsSUFBSSxDQUFDOzs7Ozs7O0dBQ3ZCLENBQUMsQ0FBQzs7QUFFSCxVQUFRLENBQUMsa0JBQWtCLEVBQUUsWUFBWTs7O0FBQ3ZDLGFBQVMsQ0FBQzs7OztpQkFDSixNQUFNOzs7Ozs7NkNBQ0YsTUFBTSxDQUFDLElBQUksRUFBRTs7O0FBRXJCLGtCQUFNLEdBQUcsSUFBSSxDQUFDOzs7Ozs7O0tBQ2YsQ0FBQyxDQUFDOztBQUVILE1BQUUsQ0FBQyw4REFBOEQsRUFBRTtVQUU3RCxVQUFVLEVBQ1YsV0FBVzs7Ozs7NkNBRkEsdURBQXlCOzs7QUFBeEMsa0JBQU07OzZDQUNpQixNQUFNLENBQUMsaUJBQWlCLEVBQUU7OztBQUE3QyxzQkFBVTs7NkNBQ1UsTUFBTSxDQUFDLHdCQUF3QixFQUFFOzs7QUFBckQsdUJBQVc7O0FBQ2Ysc0JBQVUsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLHdCQUF3QixDQUFDLENBQUM7QUFDbEQs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QUFFLENBQUMscURBQXFELEVBQUU7VUFDcEQsSUFBSSxFQUlKLFVBQVUsRUFDVixXQUFXOzs7O0FBTFgsZ0JBQUksR0FBRyxlQUFjLEVBQUUsMEJBQWlCO0FBQzFDLHFCQUFPLEVBQVAsT0FBTzthQUNSLENBQUM7OzZDQUNhLGdDQUFXLElBQUksRUFBRSxPQUFPLENBQUM7OztBQUF4QyxrQkFBTTs7NkNBQ2lCLE1BQU0sQ0FBQyxpQkFBaUIsRUFBRTs7O0FBQTdDLHNCQUFVOzs2Q0FDVSxNQUFNLENBQUMsd0JBQXdCLEVBQUU7OztBQUFyRCx1QkFBVzs7QUFDZixzQkFBVSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsd0JBQXdCLENBQUMsQ0FBQztBQUNsRCx1QkFBVyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLENBQUM7Ozs7Ozs7S0FDdkMsQ0FBQyxDQUFDO0dBQ0osQ0FBQyxDQUFDO0NBQ0osQ0FBQyxDQUFDOztBQUVILFFBQVEsQ0FBQyxPQUFPLEVBQUUsWUFBWTs7O0FBQzVCLElBQUUsQ0FBQywwQkFBMEIsRUFBRTtRQUN6QixNQUFNLEVBRU4sVUFBVTs7Ozs7MkNBRkssdURBQXlCOzs7QUFBeEMsZ0JBQU07OzJDQUNKLE1BQU0sQ0FBQyxRQUFRLEVBQUU7Ozs7MkNBQ0EsTUFBTSxDQUFDLGlCQUFpQixFQUFFOzs7QUFBN0Msb0JBQVU7O0FBQ2QsY0FBSSxVQUFVLEVBQUU7QUFDZCxzQkFBVSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLGdCQUFnQixDQUFDLENBQUM7V0FDL0M7Ozs7Ozs7R0FDRixDQUFDLENBQUM7Q0FDSixDQUFDLENBQUMiLCJmaWxlIjoidGVzdC9mdW5jdGlvbmFsL2RyaXZlci1lMmUtc3BlY3MuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY2hhaSBmcm9tICdjaGFpJztcbmltcG9ydCBjaGFpQXNQcm9taXNlZCBmcm9tICdjaGFpLWFzLXByb21pc2VkJztcbmltcG9ydCBBREIgZnJvbSAnYXBwaXVtLWFkYic7XG5pbXBvcnQgeyBBUElERU1PU19DQVBTIH0gZnJvbSAnLi9kZXNpcmVkJztcbmltcG9ydCB7IGluaXREcml2ZXIgfSBmcm9tICcuL2hlbHBlcnMvc2Vzc2lvbic7XG5cbmNoYWkuc2hvdWxkKCk7XG5jaGFpLnVzZShjaGFpQXNQcm9taXNlZCk7XG5cbmNvbnN0IEFQSURFTU9TX1BBQ0tBR0UgPSAnaW8uYXBwaXVtLmFuZHJvaWQuYXBpcyc7XG5cbmFzeW5jIGZ1bmN0aW9uIGtpbGxTZXJ2ZXIgKGFkYlBvcnQpIHtcbiAgbGV0IGFkYiA9IGF3YWl0IEFEQi5jcmVhdGVBREIoe2FkYlBvcnR9KTtcbiAgYXdhaXQgYWRiLmtpbGxTZXJ2ZXIoKTtcbn1cblxuZGVzY3JpYmUoJ2NyZWF0ZVNlc3Npb24nLCBmdW5jdGlvbiAoKSB7XG4gIGxldCBkcml2ZXI7XG4gIGJlZm9yZShhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgYXdhaXQga2lsbFNlcnZlcig1MDM3KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2RlZmF1bHQgYWRiIHBvcnQnLCBmdW5jdGlvbiAoKSB7XG4gICAgYWZ0ZXJFYWNoKGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGlmIChkcml2ZXIpIHtcbiAgICAgICAgYXdhaXQgZHJpdmVyLnF1aXQoKTtcbiAgICAgIH1cbiAgICAgIGRyaXZlciA9IG51bGw7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHN0YXJ0IGFuZHJvaWQgc2Vzc2lvbiBmb2N1c2luZyBvbiBkZWZhdWx0IHBrZyBhbmQgYWN0JywgYXN5bmMgKCkgPT4ge1xuICAgICAgZHJpdmVyID0gYXdhaXQgaW5pdERyaXZlcihBUElERU1PU19DQVBTKTtcbiAgICAgIGxldCBhcHBQYWNrYWdlID0gYXdhaXQgZHJpdmVyLmdldEN1cnJlbnRQYWNrYWdlKCk7XG4gICAgICBsZXQgYXBwQWN0aXZpdHkgPSBhd2FpdCBkcml2ZXIuZ2V0Q3VycmVudERldmljZUFjdGl2aXR5KCk7XG4gICAgICBhcHBQYWNrYWdlLnNob3VsZC5lcXVhbCgnaW8uYXBwaXVtLmFuZHJvaWQuYXBpcycpO1xuICAgICAgYXBwQWN0aXZpdHkuc2hvdWxkLmVxdWFsKCcuQXBpRGVtb3MnKTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIHN0YXJ0IGFuZHJvaWQgc2Vzc2lvbiBmb2N1c2luZyBvbiBjdXN0b20gcGtnIGFuZCBhY3QnLCBhc3luYyAoKSA9PiB7XG4gICAgICBsZXQgY2FwcyA9IE9iamVjdC5hc3NpZ24oe30sIEFQSURFTU9TX0NBUFMsIHtcbiAgICAgICAgYXBwUGFja2FnZTogJ2lvLmFwcGl1bS5hbmRyb2lkLmFwaXMnLFxuICAgICAgICBhcHBBY3Rpdml0eTogJy52aWV3LlNwbGl0VG91Y2hWaWV3JyxcbiAgICAgIH0pO1xuICAgICAgZHJpdmVyID0gYXdhaXQgaW5pdERyaXZlcihjYXBzKTtcbiAgICAgIGxldCBhcHBQYWNrYWdlID0gYXdhaXQgZHJpdmVyLmdldEN1cnJlbnRQYWNrYWdlKCk7XG4gICAgICBsZXQgYXBwQWN0aXZpdHkgPSBhd2FpdCBkcml2ZXIuZ2V0Q3VycmVudERldmljZUFjdGl2aXR5KCk7XG4gICAgICBhcHBQYWNrYWdlLnNob3VsZC5lcXVhbChjYXBzLmFwcFBhY2thZ2UpO1xuICAgICAgYXBwQWN0aXZpdHkuc2hvdWxkLmVxdWFsKGNhcHMuYXBwQWN0aXZpdHkpO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgZXJyb3Igb3V0IGZvciBub3QgYXBrIGV4dGVuc2lvbicsIGFzeW5jICgpID0+IHtcbiAgICAgIGxldCBjYXBzID0gT2JqZWN0LmFzc2lnbih7fSwgQVBJREVNT1NfQ0FQUywge1xuICAgICAgICBhcHA6ICdmb28nLFxuICAgICAgICBhcHBQYWNrYWdlOiAnaW8uYXBwaXVtLmFuZHJvaWQuYXBpcycsXG4gICAgICAgIGFwcEFjdGl2aXR5OiAnLnZpZXcuU3BsaXRUb3VjaFZpZXcnLFxuICAgICAgfSk7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBpbml0RHJpdmVyKGNhcHMpO1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbGwgdG8gJ2luaXREcml2ZXInIHNob3VsZCBub3QgaGF2ZSBzdWNjZWVkZWRgKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgZS5kYXRhLnNob3VsZC5tYXRjaCgvTmV3IGFwcCBwYXRoIGZvbyBkaWQgbm90IGhhdmUgZXh0ZW5zaW9uIFxcLmFway8pO1xuICAgICAgfVxuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgZXJyb3Igb3V0IGZvciBpbnZhbGlkIGFwcCBwYXRoJywgYXN5bmMgKCkgPT4ge1xuICAgICAgbGV0IGNhcHMgPSBPYmplY3QuYXNzaWduKHt9LCBBUElERU1PU19DQVBTLCB7XG4gICAgICAgIGFwcDogJ2Zvby5hcGsnLFxuICAgICAgICBhcHBQYWNrYWdlOiAnaW8uYXBwaXVtLmFuZHJvaWQuYXBpcycsXG4gICAgICAgIGFwcEFjdGl2aXR5OiAnLnZpZXcuU3BsaXRUb3VjaFZpZXcnLFxuICAgICAgfSk7XG5cbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IGluaXREcml2ZXIoY2Fwcyk7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgQ2FsbCB0byAnaW5pdERyaXZlcicgc2hvdWxkIG5vdCBoYXZlIHN1Y2NlZWRlZGApO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBlLmRhdGEuc2hvdWxkLm1hdGNoKC9Db3VsZCBub3QgZmluZC8pO1xuICAgICAgfVxuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgZ2V0IGRldmljZSBtb2RlbCwgbWFudWZhY3R1cmVyIGFuZCBzY3JlZW4gc2l6ZSBpbiBzZXNzaW9uIGRldGFpbHMnLCBhc3luYyAoKSA9PiB7XG4gICAgICBsZXQgY2FwcyA9IE9iamVjdC5hc3NpZ24oe30sIEFQSURFTU9TX0NBUFMsIHtcbiAgICAgICAgYXBwUGFja2FnZTogJ2lvLmFwcGl1bS5hbmRyb2lkLmFwaXMnLFxuICAgICAgICBhcHBBY3Rpdml0eTogJy52aWV3LlNwbGl0VG91Y2hWaWV3JyxcbiAgICAgIH0pO1xuICAgICAgZHJpdmVyID0gYXdhaXQgaW5pdERyaXZlcihjYXBzKTtcblxuICAgICAgbGV0IHNlcnZlckNhcHMgPSBhd2FpdCBkcml2ZXIuc2Vzc2lvbkNhcGFiaWxpdGllcygpO1xuICAgICAgc2VydmVyQ2Fwcy5kZXZpY2VTY3JlZW5TaXplLnNob3VsZC5leGlzdDtcbiAgICAgIHNlcnZlckNhcHMuZGV2aWNlTW9kZWwuc2hvdWxkLmV4aXN0O1xuICAgICAgc2VydmVyQ2Fwcy5kZXZpY2VNYW51ZmFjdHVyZXIuc2hvdWxkLmV4aXN0O1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnY3VzdG9tIGFkYiBwb3J0JywgZnVuY3Rpb24gKCkge1xuICAgIC8vIERvbid0IGRvIHRoZXNlIHRlc3RzIG9uIFRlc3RPYmplY3QuIENhbm5vdCB1c2UgVGVzdE9iamVjdCdzIEFEQi5cbiAgICBpZiAocHJvY2Vzcy5lbnYuVEVTVE9CSkVDVF9FMkVfVEVTVFMpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBsZXQgYWRiUG9ydCA9IDUwNDI7XG4gICAgbGV0IGRyaXZlcjtcblxuICAgIGJlZm9yZShhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICBhd2FpdCBraWxsU2VydmVyKDUwMzcpO1xuICAgIH0pO1xuICAgIGFmdGVyRWFjaChhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICBhd2FpdCBkcml2ZXIucXVpdCgpO1xuXG4gICAgICBhd2FpdCBraWxsU2VydmVyKGFkYlBvcnQpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBzdGFydCBhbmRyb2lkIHNlc3Npb24gd2l0aCBhIGN1c3RvbSBhZGIgcG9ydCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGxldCBjYXBzID0gT2JqZWN0LmFzc2lnbih7fSwgQVBJREVNT1NfQ0FQUywge1xuICAgICAgICBhZGJQb3J0LFxuICAgICAgfSk7XG4gICAgICBkcml2ZXIgPSBhd2FpdCBpbml0RHJpdmVyKGNhcHMsIGFkYlBvcnQpO1xuICAgICAgbGV0IGFwcFBhY2thZ2UgPSBhd2FpdCBkcml2ZXIuZ2V0Q3VycmVudFBhY2thZ2UoKTtcbiAgICAgIGxldCBhcHBBY3Rpdml0eSA9IGF3YWl0IGRyaXZlci5nZXRDdXJyZW50RGV2aWNlQWN0aXZpdHkoKTtcbiAgICAgIGFwcFBhY2thZ2Uuc2hvdWxkLmVxdWFsKCdpby5hcHBpdW0uYW5kcm9pZC5hcGlzJyk7XG4gICAgICBhcHBBY3Rpdml0eS5zaG91bGQuZXF1YWwoJy5BcGlEZW1vcycpO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuXG5kZXNjcmliZSgnY2xvc2UnLCBmdW5jdGlvbiAoKSB7XG4gIGl0KCdzaG91bGQgY2xvc2UgYXBwbGljYXRpb24nLCBhc3luYyAoKSA9PiB7XG4gICAgbGV0IGRyaXZlciA9IGF3YWl0IGluaXREcml2ZXIoQVBJREVNT1NfQ0FQUyk7XG4gICAgYXdhaXQgZHJpdmVyLmNsb3NlQXBwKCk7XG4gICAgbGV0IGFwcFBhY2thZ2UgPSBhd2FpdCBkcml2ZXIuZ2V0Q3VycmVudFBhY2thZ2UoKTtcbiAgICBpZiAoYXBwUGFja2FnZSkge1xuICAgICAgYXBwUGFja2FnZS5zaG91bGQubm90LmVxdWFsKEFQSURFTU9TX1BBQ0tBR0UpO1xuICAgIH1cbiAgfSk7XG59KTtcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
