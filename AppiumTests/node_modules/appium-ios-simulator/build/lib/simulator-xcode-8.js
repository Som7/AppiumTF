'use strict';

var _get = require('babel-runtime/helpers/get')['default'];

var _inherits = require('babel-runtime/helpers/inherits')['default'];

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _simulatorXcode6 = require('./simulator-xcode-6');

var _simulatorXcode7 = require('./simulator-xcode-7');

var _simulatorXcode72 = _interopRequireDefault(_simulatorXcode7);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _asyncbox = require('asyncbox');

var _teen_process = require('teen_process');

var _nodeSimctl = require('node-simctl');

// these sims are sloooooooow
var STARTUP_TIMEOUT = 120 * 1000;
var SAFARI_STARTUP_TIMEOUT = 25 * 1000;
var UI_CLIENT_STARTUP_TIMEOUT = 5 * 1000;
var SPRINGBOARD_BUNDLE_ID = 'com.apple.springboard';
var MOBILE_SAFARI_BUNDLE_ID = 'com.apple.mobilesafari';
var UI_CLIENT_BUNDLE_ID = 'com.apple.iphonesimulator';
var PROCESS_LAUNCH_OK_PATTERN = function PROCESS_LAUNCH_OK_PATTERN(bundleId) {
  return new RegExp(bundleId.replace('.', '\\.') + ':\\s+\\d+');
};

var SimulatorXcode8 = (function (_SimulatorXcode7) {
  _inherits(SimulatorXcode8, _SimulatorXcode7);

  function SimulatorXcode8(udid, xcodeVersion) {
    _classCallCheck(this, SimulatorXcode8);

    _get(Object.getPrototypeOf(SimulatorXcode8.prototype), 'constructor', this).call(this, udid, xcodeVersion);

    // list of files to check for when seeing if a simulator is "fresh"
    // (meaning it has never been booted).
    // If these files are present, we assume it's been successfully booted
    this.isFreshFiles = ['Library/Cookies', 'Library/Preferences/.GlobalPreferences.plist', 'Library/Preferences/com.apple.springboard.plist', 'var/run/syslog.pid'];
  }

  /**
   * @return {string} Bundle identifier of Simulator UI client.
   */

  _createClass(SimulatorXcode8, [{
    key: 'isUIClientRunning',

    /**
     * Check the state of Simulator UI client.
     * @Override
     *
     * @return {boolean} True of if UI client is running or false otherwise.
     */
    value: function isUIClientRunning() {
      var args, _ref, stdout, count;

      return _regeneratorRuntime.async(function isUIClientRunning$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            args = ['-e', 'tell application "System Events" to count processes whose bundle identifier is "' + this.uiClientBundleId + '"'];
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap((0, _teen_process.exec)('osascript', args));

          case 3:
            _ref = context$2$0.sent;
            stdout = _ref.stdout;
            count = parseInt(stdout, 10);

            if (isNaN(count)) {
              _logger2['default'].errorAndThrow('Cannot parse the count of running Simulator UI client instances from \'osascript ' + args + '\' output: ' + stdout);
            }
            _logger2['default'].debug('The count of running Simulator UI client instances is ' + count);
            return context$2$0.abrupt('return', count >= 1);

          case 9:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /**
     * Kill the UI client if it is running.
     *
     * @param {boolean} force - Set it to true to send SIGKILL signal to Simulator process.
     *                          SIGTERM will be sent by default.
     * @return {boolean} True if the UI client was successfully killed or false
     *                   if it is not running.
     */
  }, {
    key: 'killUIClient',
    value: function killUIClient() {
      var force = arguments.length <= 0 || arguments[0] === undefined ? false : arguments[0];

      var osascriptArgs, _ref2, stdout, killArgs;

      return _regeneratorRuntime.async(function killUIClient$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            osascriptArgs = ['-e', 'tell application "System Events" to unix id of processes whose bundle identifier is "' + this.uiClientBundleId + '"'];
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap((0, _teen_process.exec)('osascript', osascriptArgs));

          case 3:
            _ref2 = context$2$0.sent;
            stdout = _ref2.stdout;

            if (stdout.trim().length) {
              context$2$0.next = 7;
              break;
            }

            return context$2$0.abrupt('return', false);

          case 7:
            killArgs = force ? ['-9', stdout.trim()] : [stdout.trim()];
            context$2$0.next = 10;
            return _regeneratorRuntime.awrap((0, _teen_process.exec)('kill', killArgs));

          case 10:
            return context$2$0.abrupt('return', true);

          case 11:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /**
     * Start the Simulator UI client with the given arguments
     * and wait until it is running.
     * @override
     */
  }, {
    key: 'startUIClient',
    value: function startUIClient() {
      var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];
      return _regeneratorRuntime.async(function startUIClient$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(_get(Object.getPrototypeOf(SimulatorXcode8.prototype), 'startUIClient', this).call(this, opts));

          case 2:
            context$2$0.prev = 2;
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap((0, _asyncbox.waitForCondition)(function callee$2$0() {
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    context$3$0.next = 2;
                    return _regeneratorRuntime.awrap(this.isUIClientRunning());

                  case 2:
                    return context$3$0.abrupt('return', context$3$0.sent);

                  case 3:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this);
            }, { waitMs: UI_CLIENT_STARTUP_TIMEOUT, intervalMs: 300 }));

          case 5:
            context$2$0.next = 10;
            break;

          case 7:
            context$2$0.prev = 7;
            context$2$0.t0 = context$2$0['catch'](2);

            _logger2['default'].warn('The Simulator UI client is not running after ' + UI_CLIENT_STARTUP_TIMEOUT + ' ms timeout');

          case 10:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[2, 7]]);
    }

    /**
     * Verify whether the particular application is installed on Simulator.
     * @override
     *
     * @param {string} bundleId - The bundle id of the application to be checked.
     * @return {boolean} True if the given application is installed.
     */
  }, {
    key: 'isAppInstalled',
    value: function isAppInstalled(bundleId) {
      var appContainer, info;
      return _regeneratorRuntime.async(function isAppInstalled$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.prev = 0;
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap((0, _nodeSimctl.getAppContainer)(this.udid, bundleId, false));

          case 3:
            appContainer = context$2$0.sent;
            return context$2$0.abrupt('return', appContainer.endsWith('.app'));

          case 7:
            context$2$0.prev = 7;
            context$2$0.t0 = context$2$0['catch'](0);
            context$2$0.prev = 9;
            context$2$0.next = 12;
            return _regeneratorRuntime.awrap((0, _nodeSimctl.appInfo)(this.udid, bundleId));

          case 12:
            info = context$2$0.sent;
            return context$2$0.abrupt('return', info.indexOf('ApplicationType') !== -1);

          case 16:
            context$2$0.prev = 16;
            context$2$0.t1 = context$2$0['catch'](9);
            return context$2$0.abrupt('return', false);

          case 19:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[0, 7], [9, 16]]);
    }

    /**
     * @return {string} Application bundle id, which signals that Simulator booting is
     * competed if it is running.
     */
  }, {
    key: 'waitForBoot',

    /**
     * Verify whether the Simulator booting is completed and/or wait for it
     * until the timeout expires.
     * @override
     *
     * @param {number} startupTimeout - the number of milliseconds to wait until booting is completed.
     * @emits BOOT_COMPLETED_EVENT if the current Simulator is ready to accept simctl commands, like 'install'.
     */
    value: function waitForBoot(startupTimeout) {
      var startupTimestamp, lastError;
      return _regeneratorRuntime.async(function waitForBoot$(context$2$0) {
        var _this3 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            startupTimestamp = process.hrtime();
            lastError = null;
            context$2$0.prev = 2;
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap((function callee$2$0() {
              var isOnBootCompletedEmitted;
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                var _this2 = this;

                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    isOnBootCompletedEmitted = false;
                    context$3$0.next = 3;
                    return _regeneratorRuntime.awrap((0, _asyncbox.waitForCondition)(function callee$3$0() {
                      var _ref3,
                      // 'springboard' process should be the last one to start after boot
                      // 'simctl launch' will block until this process is running or fail if booting is still in progress
                      stdout;

                      return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
                        while (1) switch (context$4$0.prev = context$4$0.next) {
                          case 0:
                            context$4$0.prev = 0;
                            context$4$0.next = 3;
                            return _regeneratorRuntime.awrap((0, _teen_process.exec)('xcrun', ['simctl', 'launch', this.udid, this.startupPollBundleId]));

                          case 3:
                            _ref3 = context$4$0.sent;
                            stdout = _ref3.stdout;

                            if (!PROCESS_LAUNCH_OK_PATTERN(this.startupPollBundleId).test(stdout)) {
                              context$4$0.next = 8;
                              break;
                            }

                            if (!isOnBootCompletedEmitted) {
                              isOnBootCompletedEmitted = true;
                              this.emit(_simulatorXcode6.BOOT_COMPLETED_EVENT);
                            }

                            return context$4$0.abrupt('return', true);

                          case 8:
                            context$4$0.next = 13;
                            break;

                          case 10:
                            context$4$0.prev = 10;
                            context$4$0.t0 = context$4$0['catch'](0);

                            lastError = context$4$0.t0.stderr || context$4$0.t0.message;

                          case 13:
                            return context$4$0.abrupt('return', false);

                          case 14:
                          case 'end':
                            return context$4$0.stop();
                        }
                      }, null, _this2, [[0, 10]]);
                    }, { waitMs: startupTimeout, intervalMs: 1500 }));

                  case 3:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this3);
            })());

          case 5:
            context$2$0.next = 10;
            break;

          case 7:
            context$2$0.prev = 7;
            context$2$0.t0 = context$2$0['catch'](2);

            _logger2['default'].errorAndThrow('Simulator is not booted after ' + process.hrtime(startupTimestamp)[0] + ' seconds ' + ('because of: ' + (lastError || 'an unknown error')));

          case 10:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[2, 7]]);
    }

    /**
     * Open the given URL in mobile Safari browser.
     * The browser will be started automatically if it is not running.
     * @override
     *
     * @param {string} url - The URL to be opened.
     */
  }, {
    key: 'openUrl',
    value: function openUrl(url) {
      var launchTimestamp, lastError;
      return _regeneratorRuntime.async(function openUrl$(context$2$0) {
        var _this4 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.isRunning());

          case 2:
            if (context$2$0.sent) {
              context$2$0.next = 4;
              break;
            }

            throw new Error('Tried to open ' + url + ', but Simulator is not in Booted state');

          case 4:
            launchTimestamp = process.hrtime();
            lastError = null;
            context$2$0.prev = 6;
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap((0, _asyncbox.waitForCondition)(function callee$2$0() {
              var _ref4,
              // This is to make sure Safari is already running
              stdout;

              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    context$3$0.prev = 0;
                    context$3$0.next = 3;
                    return _regeneratorRuntime.awrap((0, _teen_process.exec)('xcrun', ['simctl', 'launch', this.udid, MOBILE_SAFARI_BUNDLE_ID]));

                  case 3:
                    _ref4 = context$3$0.sent;
                    stdout = _ref4.stdout;

                    if (!PROCESS_LAUNCH_OK_PATTERN(MOBILE_SAFARI_BUNDLE_ID).test(stdout)) {
                      context$3$0.next = 9;
                      break;
                    }

                    context$3$0.next = 8;
                    return _regeneratorRuntime.awrap((0, _nodeSimctl.openUrl)(this.udid, url));

                  case 8:
                    return context$3$0.abrupt('return', true);

                  case 9:
                    context$3$0.next = 15;
                    break;

                  case 11:
                    context$3$0.prev = 11;
                    context$3$0.t0 = context$3$0['catch'](0);

                    _logger2['default'].error('Failed to open \'' + url + '\' in Safari. Retrying...');
                    lastError = context$3$0.t0.stderr || context$3$0.t0.message;

                  case 15:
                    return context$3$0.abrupt('return', false);

                  case 16:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this4, [[0, 11]]);
            }, { waitMs: SAFARI_STARTUP_TIMEOUT, intervalMs: 500 }));

          case 9:
            context$2$0.next = 14;
            break;

          case 11:
            context$2$0.prev = 11;
            context$2$0.t0 = context$2$0['catch'](6);

            _logger2['default'].errorAndThrow('Safari cannot open \'' + url + '\' after ' + process.hrtime(launchTimestamp)[0] + ' seconds ' + ('because of: ' + (lastError || 'an unknown error')));

          case 14:
            _logger2['default'].debug('Safari has successfully opened \'' + url + '\' in ' + process.hrtime(launchTimestamp)[0] + ' seconds');

          case 15:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[6, 11]]);
    }

    /**
     * Clean up the directories for mobile Safari.
     * @override
     *
     * @param {boolean} keepPrefs - Whether to keep Safari preferences from being deleted.
     */
  }, {
    key: 'cleanSafari',
    value: function cleanSafari() {
      var keepPrefs = arguments.length <= 0 || arguments[0] === undefined ? true : arguments[0];
      return _regeneratorRuntime.async(function cleanSafari$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.prev = 0;
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap((0, _nodeSimctl.terminate)(this.udid, MOBILE_SAFARI_BUNDLE_ID));

          case 3:
            context$2$0.next = 7;
            break;

          case 5:
            context$2$0.prev = 5;
            context$2$0.t0 = context$2$0['catch'](0);

          case 7:
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(_get(Object.getPrototypeOf(SimulatorXcode8.prototype), 'cleanSafari', this).call(this, keepPrefs));

          case 9:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[0, 5]]);
    }

    /**
     * Clean/scrub the particular application on Simulator.
     * @override
     *
     * @param {string} appFile - Application name minus ".app".
     * @param {string} appBundleId - Bundle identifier of the application.
     * @param {boolean} scrub - If `scrub` is false, we want to clean by deleting the app and all
     *   files associated with it. If `scrub` is true, we just want to delete the preferences and
     *   changed files.
     */
  }, {
    key: 'cleanCustomApp',
    value: function cleanCustomApp(appFile, appBundleId) {
      var scrub = arguments.length <= 2 || arguments[2] === undefined ? false : arguments[2];
      return _regeneratorRuntime.async(function cleanCustomApp$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.prev = 0;
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap((0, _nodeSimctl.terminate)(this.udid, appBundleId));

          case 3:
            context$2$0.next = 7;
            break;

          case 5:
            context$2$0.prev = 5;
            context$2$0.t0 = context$2$0['catch'](0);

          case 7:
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(_get(Object.getPrototypeOf(SimulatorXcode8.prototype), 'cleanCustomApp', this).call(this, appFile, appBundleId, scrub));

          case 9:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[0, 5]]);
    }

    /**
     * Perform Shake gesture on Simulator window via AppleScript.
     */
  }, {
    key: 'shake',
    value: function shake() {
      return _regeneratorRuntime.async(function shake$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.executeUIClientScript('\n      tell application "System Events"\n        tell process "Simulator"\n          keystroke "z" using {control down, command down}\n        end tell\n      end tell\n    '));

          case 2:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /**
     * Set custom geolocation parameters for the given Simulator using AppleScript.
     *
     * @param {string} latitude - The latitude value, which is going to be entered
     *   into the corresponding edit field, for example '39,0006'.
     * @param {string} longitude - The longitude value, which is going to be entered
     *   into the corresponding edit field, for example '19,0068'.
     * @returns {boolean} True if the given parameters have correct format and were successfully accepted.
     */
  }, {
    key: 'setGeolocation',
    value: function setGeolocation(latitude, longitude) {
      var output;
      return _regeneratorRuntime.async(function setGeolocation$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.executeUIClientScript('\n      tell application "System Events"\n        tell process "Simulator"\n          set featureName to "Custom Location"\n          set dstMenuItem to menu item (featureName & "…") of menu 1 of menu item "Location" of menu 1 of menu bar item "Debug" of menu bar 1\n          click dstMenuItem\n          delay 1\n          set value of text field 1 of window featureName to "' + latitude + '"\n          delay 0.5\n          set value of text field 2 of window featureName to "' + longitude + '"\n          delay 0.5\n          click button "OK" of window featureName\n          delay 0.5\n          set isInvisible to (not (exists (window featureName)))\n        end tell\n      end tell\n    '));

          case 2:
            output = context$2$0.sent;

            _logger2['default'].debug('Geolocation parameters dialog accepted: ' + output);
            return context$2$0.abrupt('return', _lodash2['default'].isString(output) && output.trim() === 'true');

          case 5:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'uiClientBundleId',
    get: function get() {
      return UI_CLIENT_BUNDLE_ID;
    }
  }, {
    key: 'startupPollBundleId',
    get: function get() {
      return SPRINGBOARD_BUNDLE_ID;
    }

    /**
     * @return {number} The max number of milliseconds to wait until Simulator booting is completed.
     */
  }, {
    key: 'startupTimeout',
    get: function get() {
      return STARTUP_TIMEOUT;
    }
  }]);

  return SimulatorXcode8;
})(_simulatorXcode72['default']);

exports['default'] = SimulatorXcode8;
module.exports = exports['default'];

// get_app_container subcommand fails for system applications,
// so we try the hidden appinfo subcommand, which prints correct info for
// system/hidden apps

// ignore error

// ignore error
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zaW11bGF0b3IteGNvZGUtOC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7K0JBQXFDLHFCQUFxQjs7K0JBQzlCLHFCQUFxQjs7OztzQkFDbkMsUUFBUTs7OztzQkFDTixVQUFVOzs7O3dCQUNPLFVBQVU7OzRCQUN0QixjQUFjOzswQkFDMkMsYUFBYTs7O0FBSTNGLElBQU0sZUFBZSxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUM7QUFDbkMsSUFBTSxzQkFBc0IsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDO0FBQ3pDLElBQU0seUJBQXlCLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQztBQUMzQyxJQUFNLHFCQUFxQixHQUFHLHVCQUF1QixDQUFDO0FBQ3RELElBQU0sdUJBQXVCLEdBQUcsd0JBQXdCLENBQUM7QUFDekQsSUFBTSxtQkFBbUIsR0FBRywyQkFBMkIsQ0FBQztBQUN4RCxJQUFNLHlCQUF5QixHQUFHLFNBQTVCLHlCQUF5QixDQUFJLFFBQVE7U0FBSyxJQUFJLE1BQU0sQ0FBSSxRQUFRLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsZUFBWTtDQUFBLENBQUM7O0lBRWpHLGVBQWU7WUFBZixlQUFlOztBQUNQLFdBRFIsZUFBZSxDQUNOLElBQUksRUFBRSxZQUFZLEVBQUU7MEJBRDdCLGVBQWU7O0FBRWpCLCtCQUZFLGVBQWUsNkNBRVgsSUFBSSxFQUFFLFlBQVksRUFBRTs7Ozs7QUFLMUIsUUFBSSxDQUFDLFlBQVksR0FBRyxDQUNsQixpQkFBaUIsRUFDakIsOENBQThDLEVBQzlDLGlEQUFpRCxFQUNqRCxvQkFBb0IsQ0FDckIsQ0FBQztHQUNIOzs7Ozs7ZUFiRyxlQUFlOzs7Ozs7Ozs7V0E0Qks7VUFDaEIsSUFBSSxRQUNILE1BQU0sRUFDUCxLQUFLOzs7OztBQUZMLGdCQUFJLEdBQUcsQ0FBQyxJQUFJLHVGQUFxRixJQUFJLENBQUMsZ0JBQWdCLE9BQUk7OzZDQUN6Ryx3QkFBSyxXQUFX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QWU7OztxQkF3UU4sZUFBZSIsImZpbGUiOiJsaWIvc2ltdWxhdG9yLXhjb2RlLTguanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCT09UX0NPTVBMRVRFRF9FVkVOVCB9IGZyb20gJy4vc2ltdWxhdG9yLXhjb2RlLTYnO1xuaW1wb3J0IFNpbXVsYXRvclhjb2RlNyBmcm9tICcuL3NpbXVsYXRvci14Y29kZS03JztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCB7IHdhaXRGb3JDb25kaXRpb24gfSBmcm9tICdhc3luY2JveCc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCB7IGdldEFwcENvbnRhaW5lciwgb3BlblVybCBhcyBzaW1jdGxPcGVuVXJsLCB0ZXJtaW5hdGUsIGFwcEluZm8gfSBmcm9tICdub2RlLXNpbWN0bCc7XG5cblxuLy8gdGhlc2Ugc2ltcyBhcmUgc2xvb29vb29vb3dcbmNvbnN0IFNUQVJUVVBfVElNRU9VVCA9IDEyMCAqIDEwMDA7XG5jb25zdCBTQUZBUklfU1RBUlRVUF9USU1FT1VUID0gMjUgKiAxMDAwO1xuY29uc3QgVUlfQ0xJRU5UX1NUQVJUVVBfVElNRU9VVCA9IDUgKiAxMDAwO1xuY29uc3QgU1BSSU5HQk9BUkRfQlVORExFX0lEID0gJ2NvbS5hcHBsZS5zcHJpbmdib2FyZCc7XG5jb25zdCBNT0JJTEVfU0FGQVJJX0JVTkRMRV9JRCA9ICdjb20uYXBwbGUubW9iaWxlc2FmYXJpJztcbmNvbnN0IFVJX0NMSUVOVF9CVU5ETEVfSUQgPSAnY29tLmFwcGxlLmlwaG9uZXNpbXVsYXRvcic7XG5jb25zdCBQUk9DRVNTX0xBVU5DSF9PS19QQVRURVJOID0gKGJ1bmRsZUlkKSA9PiBuZXcgUmVnRXhwKGAke2J1bmRsZUlkLnJlcGxhY2UoJy4nLCAnXFxcXC4nKX06XFxcXHMrXFxcXGQrYCk7XG5cbmNsYXNzIFNpbXVsYXRvclhjb2RlOCBleHRlbmRzIFNpbXVsYXRvclhjb2RlNyB7XG4gIGNvbnN0cnVjdG9yICh1ZGlkLCB4Y29kZVZlcnNpb24pIHtcbiAgICBzdXBlcih1ZGlkLCB4Y29kZVZlcnNpb24pO1xuXG4gICAgLy8gbGlzdCBvZiBmaWxlcyB0byBjaGVjayBmb3Igd2hlbiBzZWVpbmcgaWYgYSBzaW11bGF0b3IgaXMgXCJmcmVzaFwiXG4gICAgLy8gKG1lYW5pbmcgaXQgaGFzIG5ldmVyIGJlZW4gYm9vdGVkKS5cbiAgICAvLyBJZiB0aGVzZSBmaWxlcyBhcmUgcHJlc2VudCwgd2UgYXNzdW1lIGl0J3MgYmVlbiBzdWNjZXNzZnVsbHkgYm9vdGVkXG4gICAgdGhpcy5pc0ZyZXNoRmlsZXMgPSBbXG4gICAgICAnTGlicmFyeS9Db29raWVzJyxcbiAgICAgICdMaWJyYXJ5L1ByZWZlcmVuY2VzLy5HbG9iYWxQcmVmZXJlbmNlcy5wbGlzdCcsXG4gICAgICAnTGlicmFyeS9QcmVmZXJlbmNlcy9jb20uYXBwbGUuc3ByaW5nYm9hcmQucGxpc3QnLFxuICAgICAgJ3Zhci9ydW4vc3lzbG9nLnBpZCdcbiAgICBdO1xuICB9XG5cbiAgLyoqXG4gICAqIEByZXR1cm4ge3N0cmluZ30gQnVuZGxlIGlkZW50aWZpZXIgb2YgU2ltdWxhdG9yIFVJIGNsaWVudC5cbiAgICovXG4gIGdldCB1aUNsaWVudEJ1bmRsZUlkICgpIHtcbiAgICByZXR1cm4gVUlfQ0xJRU5UX0JVTkRMRV9JRDtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVjayB0aGUgc3RhdGUgb2YgU2ltdWxhdG9yIFVJIGNsaWVudC5cbiAgICogQE92ZXJyaWRlXG4gICAqXG4gICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgb2YgaWYgVUkgY2xpZW50IGlzIHJ1bm5pbmcgb3IgZmFsc2Ugb3RoZXJ3aXNlLlxuICAgKi9cbiAgYXN5bmMgaXNVSUNsaWVudFJ1bm5pbmcgKCkge1xuICAgIGNvbnN0IGFyZ3MgPSBbJy1lJywgYHRlbGwgYXBwbGljYXRpb24gXCJTeXN0ZW0gRXZlbnRzXCIgdG8gY291bnQgcHJvY2Vzc2VzIHdob3NlIGJ1bmRsZSBpZGVudGlmaWVyIGlzIFwiJHt0aGlzLnVpQ2xpZW50QnVuZGxlSWR9XCJgXTtcbiAgICBjb25zdCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWMoJ29zYXNjcmlwdCcsIGFyZ3MpO1xuICAgIGNvbnN0IGNvdW50ID0gcGFyc2VJbnQoc3Rkb3V0LCAxMCk7XG4gICAgaWYgKGlzTmFOKGNvdW50KSkge1xuICAgICAgbG9nLmVycm9yQW5kVGhyb3coYENhbm5vdCBwYXJzZSB0aGUgY291bnQgb2YgcnVubmluZyBTaW11bGF0b3IgVUkgY2xpZW50IGluc3RhbmNlcyBmcm9tICdvc2FzY3JpcHQgJHthcmdzfScgb3V0cHV0OiAke3N0ZG91dH1gKTtcbiAgICB9XG4gICAgbG9nLmRlYnVnKGBUaGUgY291bnQgb2YgcnVubmluZyBTaW11bGF0b3IgVUkgY2xpZW50IGluc3RhbmNlcyBpcyAke2NvdW50fWApO1xuICAgIHJldHVybiBjb3VudCA+PSAxO1xuICB9XG5cbiAgLyoqXG4gICAqIEtpbGwgdGhlIFVJIGNsaWVudCBpZiBpdCBpcyBydW5uaW5nLlxuICAgKlxuICAgKiBAcGFyYW0ge2Jvb2xlYW59IGZvcmNlIC0gU2V0IGl0IHRvIHRydWUgdG8gc2VuZCBTSUdLSUxMIHNpZ25hbCB0byBTaW11bGF0b3IgcHJvY2Vzcy5cbiAgICogICAgICAgICAgICAgICAgICAgICAgICAgIFNJR1RFUk0gd2lsbCBiZSBzZW50IGJ5IGRlZmF1bHQuXG4gICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIFVJIGNsaWVudCB3YXMgc3VjY2Vzc2Z1bGx5IGtpbGxlZCBvciBmYWxzZVxuICAgKiAgICAgICAgICAgICAgICAgICBpZiBpdCBpcyBub3QgcnVubmluZy5cbiAgICovXG4gIGFzeW5jIGtpbGxVSUNsaWVudCAoZm9yY2UgPSBmYWxzZSkge1xuICAgIGNvbnN0IG9zYXNjcmlwdEFyZ3MgPSBbJy1lJywgYHRlbGwgYXBwbGljYXRpb24gXCJTeXN0ZW0gRXZlbnRzXCIgdG8gdW5peCBpZCBvZiBwcm9jZXNzZXMgd2hvc2UgYnVuZGxlIGlkZW50aWZpZXIgaXMgXCIke3RoaXMudWlDbGllbnRCdW5kbGVJZH1cImBdO1xuICAgIGNvbnN0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYygnb3Nhc2NyaXB0Jywgb3Nhc2NyaXB0QXJncyk7XG4gICAgaWYgKCFzdGRvdXQudHJpbSgpLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBjb25zdCBraWxsQXJncyA9IGZvcmNlID8gWyctOScsIHN0ZG91dC50cmltKCldIDogW3N0ZG91dC50cmltKCldO1xuICAgIGF3YWl0IGV4ZWMoJ2tpbGwnLCBraWxsQXJncyk7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICAvKipcbiAgICogU3RhcnQgdGhlIFNpbXVsYXRvciBVSSBjbGllbnQgd2l0aCB0aGUgZ2l2ZW4gYXJndW1lbnRzXG4gICAqIGFuZCB3YWl0IHVudGlsIGl0IGlzIHJ1bm5pbmcuXG4gICAqIEBvdmVycmlkZVxuICAgKi9cbiAgYXN5bmMgc3RhcnRVSUNsaWVudCAob3B0cyA9IHt9KSB7XG4gICAgYXdhaXQgc3VwZXIuc3RhcnRVSUNsaWVudChvcHRzKTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgd2FpdEZvckNvbmRpdGlvbihhc3luYyAoKSA9PiB7XG4gICAgICAgIHJldHVybiBhd2FpdCB0aGlzLmlzVUlDbGllbnRSdW5uaW5nKCk7XG4gICAgICB9LCB7d2FpdE1zOiBVSV9DTElFTlRfU1RBUlRVUF9USU1FT1VULCBpbnRlcnZhbE1zOiAzMDB9KTtcbiAgICB9IGNhdGNoIChpZ24pIHtcbiAgICAgIGxvZy53YXJuKGBUaGUgU2ltdWxhdG9yIFVJIGNsaWVudCBpcyBub3QgcnVubmluZyBhZnRlciAke1VJX0NMSUVOVF9TVEFSVFVQX1RJTUVPVVR9IG1zIHRpbWVvdXRgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVmVyaWZ5IHdoZXRoZXIgdGhlIHBhcnRpY3VsYXIgYXBwbGljYXRpb24gaXMgaW5zdGFsbGVkIG9uIFNpbXVsYXRvci5cbiAgICogQG92ZXJyaWRlXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBidW5kbGVJZCAtIFRoZSBidW5kbGUgaWQgb2YgdGhlIGFwcGxpY2F0aW9uIHRvIGJlIGNoZWNrZWQuXG4gICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgdGhlIGdpdmVuIGFwcGxpY2F0aW9uIGlzIGluc3RhbGxlZC5cbiAgICovXG4gIGFzeW5jIGlzQXBwSW5zdGFsbGVkIChidW5kbGVJZCkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBhcHBDb250YWluZXIgPSBhd2FpdCBnZXRBcHBDb250YWluZXIodGhpcy51ZGlkLCBidW5kbGVJZCwgZmFsc2UpO1xuICAgICAgcmV0dXJuIGFwcENvbnRhaW5lci5lbmRzV2l0aCgnLmFwcCcpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgLy8gZ2V0X2FwcF9jb250YWluZXIgc3ViY29tbWFuZCBmYWlscyBmb3Igc3lzdGVtIGFwcGxpY2F0aW9ucyxcbiAgICAgIC8vIHNvIHdlIHRyeSB0aGUgaGlkZGVuIGFwcGluZm8gc3ViY29tbWFuZCwgd2hpY2ggcHJpbnRzIGNvcnJlY3QgaW5mbyBmb3JcbiAgICAgIC8vIHN5c3RlbS9oaWRkZW4gYXBwc1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgaW5mbyA9IGF3YWl0IGFwcEluZm8odGhpcy51ZGlkLCBidW5kbGVJZCk7XG4gICAgICAgIHJldHVybiBpbmZvLmluZGV4T2YoJ0FwcGxpY2F0aW9uVHlwZScpICE9PSAtMTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBAcmV0dXJuIHtzdHJpbmd9IEFwcGxpY2F0aW9uIGJ1bmRsZSBpZCwgd2hpY2ggc2lnbmFscyB0aGF0IFNpbXVsYXRvciBib290aW5nIGlzXG4gICAqIGNvbXBldGVkIGlmIGl0IGlzIHJ1bm5pbmcuXG4gICAqL1xuICBnZXQgc3RhcnR1cFBvbGxCdW5kbGVJZCAoKSB7XG4gICAgcmV0dXJuIFNQUklOR0JPQVJEX0JVTkRMRV9JRDtcbiAgfVxuXG4gIC8qKlxuICAgKiBAcmV0dXJuIHtudW1iZXJ9IFRoZSBtYXggbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0byB3YWl0IHVudGlsIFNpbXVsYXRvciBib290aW5nIGlzIGNvbXBsZXRlZC5cbiAgICovXG4gIGdldCBzdGFydHVwVGltZW91dCAoKSB7XG4gICAgcmV0dXJuIFNUQVJUVVBfVElNRU9VVDtcbiAgfVxuXG4gIC8qKlxuICAgKiBWZXJpZnkgd2hldGhlciB0aGUgU2ltdWxhdG9yIGJvb3RpbmcgaXMgY29tcGxldGVkIGFuZC9vciB3YWl0IGZvciBpdFxuICAgKiB1bnRpbCB0aGUgdGltZW91dCBleHBpcmVzLlxuICAgKiBAb3ZlcnJpZGVcbiAgICpcbiAgICogQHBhcmFtIHtudW1iZXJ9IHN0YXJ0dXBUaW1lb3V0IC0gdGhlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgdG8gd2FpdCB1bnRpbCBib290aW5nIGlzIGNvbXBsZXRlZC5cbiAgICogQGVtaXRzIEJPT1RfQ09NUExFVEVEX0VWRU5UIGlmIHRoZSBjdXJyZW50IFNpbXVsYXRvciBpcyByZWFkeSB0byBhY2NlcHQgc2ltY3RsIGNvbW1hbmRzLCBsaWtlICdpbnN0YWxsJy5cbiAgICovXG4gIGFzeW5jIHdhaXRGb3JCb290IChzdGFydHVwVGltZW91dCkge1xuICAgIGNvbnN0IHN0YXJ0dXBUaW1lc3RhbXAgPSBwcm9jZXNzLmhydGltZSgpO1xuICAgIGxldCBsYXN0RXJyb3IgPSBudWxsO1xuICAgIHRyeSB7XG4gICAgICBsZXQgaXNPbkJvb3RDb21wbGV0ZWRFbWl0dGVkID0gZmFsc2U7XG4gICAgICBhd2FpdCB3YWl0Rm9yQ29uZGl0aW9uKGFzeW5jICgpID0+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAvLyAnc3ByaW5nYm9hcmQnIHByb2Nlc3Mgc2hvdWxkIGJlIHRoZSBsYXN0IG9uZSB0byBzdGFydCBhZnRlciBib290XG4gICAgICAgICAgLy8gJ3NpbWN0bCBsYXVuY2gnIHdpbGwgYmxvY2sgdW50aWwgdGhpcyBwcm9jZXNzIGlzIHJ1bm5pbmcgb3IgZmFpbCBpZiBib290aW5nIGlzIHN0aWxsIGluIHByb2dyZXNzXG4gICAgICAgICAgY29uc3Qge3N0ZG91dH0gPSBhd2FpdCBleGVjKCd4Y3J1bicsIFsnc2ltY3RsJywgJ2xhdW5jaCcsIHRoaXMudWRpZCwgdGhpcy5zdGFydHVwUG9sbEJ1bmRsZUlkXSk7XG4gICAgICAgICAgaWYgKFBST0NFU1NfTEFVTkNIX09LX1BBVFRFUk4odGhpcy5zdGFydHVwUG9sbEJ1bmRsZUlkKS50ZXN0KHN0ZG91dCkpIHtcbiAgICAgICAgICAgIGlmICghaXNPbkJvb3RDb21wbGV0ZWRFbWl0dGVkKSB7XG4gICAgICAgICAgICAgIGlzT25Cb290Q29tcGxldGVkRW1pdHRlZCA9IHRydWU7XG4gICAgICAgICAgICAgIHRoaXMuZW1pdChCT09UX0NPTVBMRVRFRF9FVkVOVCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgbGFzdEVycm9yID0gZXJyLnN0ZGVyciB8fCBlcnIubWVzc2FnZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9LCB7d2FpdE1zOiBzdGFydHVwVGltZW91dCwgaW50ZXJ2YWxNczogMTUwMH0pO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLmVycm9yQW5kVGhyb3coYFNpbXVsYXRvciBpcyBub3QgYm9vdGVkIGFmdGVyICR7cHJvY2Vzcy5ocnRpbWUoc3RhcnR1cFRpbWVzdGFtcClbMF19IHNlY29uZHMgYCArXG4gICAgICAgICAgICAgICAgICAgICAgICBgYmVjYXVzZSBvZjogJHtsYXN0RXJyb3IgfHwgJ2FuIHVua25vd24gZXJyb3InfWApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBPcGVuIHRoZSBnaXZlbiBVUkwgaW4gbW9iaWxlIFNhZmFyaSBicm93c2VyLlxuICAgKiBUaGUgYnJvd3NlciB3aWxsIGJlIHN0YXJ0ZWQgYXV0b21hdGljYWxseSBpZiBpdCBpcyBub3QgcnVubmluZy5cbiAgICogQG92ZXJyaWRlXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSB1cmwgLSBUaGUgVVJMIHRvIGJlIG9wZW5lZC5cbiAgICovXG4gIGFzeW5jIG9wZW5VcmwgKHVybCkge1xuICAgIGlmICghYXdhaXQgdGhpcy5pc1J1bm5pbmcoKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUcmllZCB0byBvcGVuICR7dXJsfSwgYnV0IFNpbXVsYXRvciBpcyBub3QgaW4gQm9vdGVkIHN0YXRlYCk7XG4gICAgfVxuICAgIGNvbnN0IGxhdW5jaFRpbWVzdGFtcCA9IHByb2Nlc3MuaHJ0aW1lKCk7XG4gICAgbGV0IGxhc3RFcnJvciA9IG51bGw7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHdhaXRGb3JDb25kaXRpb24oYXN5bmMgKCkgPT4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIC8vIFRoaXMgaXMgdG8gbWFrZSBzdXJlIFNhZmFyaSBpcyBhbHJlYWR5IHJ1bm5pbmdcbiAgICAgICAgICBjb25zdCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWMoJ3hjcnVuJywgWydzaW1jdGwnLCAnbGF1bmNoJywgdGhpcy51ZGlkLCBNT0JJTEVfU0FGQVJJX0JVTkRMRV9JRF0pO1xuICAgICAgICAgIGlmIChQUk9DRVNTX0xBVU5DSF9PS19QQVRURVJOKE1PQklMRV9TQUZBUklfQlVORExFX0lEKS50ZXN0KHN0ZG91dCkpIHtcbiAgICAgICAgICAgIGF3YWl0IHNpbWN0bE9wZW5VcmwodGhpcy51ZGlkLCB1cmwpO1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICBsb2cuZXJyb3IoYEZhaWxlZCB0byBvcGVuICcke3VybH0nIGluIFNhZmFyaS4gUmV0cnlpbmcuLi5gKTtcbiAgICAgICAgICBsYXN0RXJyb3IgPSBlcnIuc3RkZXJyIHx8IGVyci5tZXNzYWdlO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH0sIHt3YWl0TXM6IFNBRkFSSV9TVEFSVFVQX1RJTUVPVVQsIGludGVydmFsTXM6IDUwMH0pO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLmVycm9yQW5kVGhyb3coYFNhZmFyaSBjYW5ub3Qgb3BlbiAnJHt1cmx9JyBhZnRlciAke3Byb2Nlc3MuaHJ0aW1lKGxhdW5jaFRpbWVzdGFtcClbMF19IHNlY29uZHMgYCArXG4gICAgICAgICAgICAgICAgICAgICAgICBgYmVjYXVzZSBvZjogJHtsYXN0RXJyb3IgfHwgJ2FuIHVua25vd24gZXJyb3InfWApO1xuICAgIH1cbiAgICBsb2cuZGVidWcoYFNhZmFyaSBoYXMgc3VjY2Vzc2Z1bGx5IG9wZW5lZCAnJHt1cmx9JyBpbiAke3Byb2Nlc3MuaHJ0aW1lKGxhdW5jaFRpbWVzdGFtcClbMF19IHNlY29uZHNgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDbGVhbiB1cCB0aGUgZGlyZWN0b3JpZXMgZm9yIG1vYmlsZSBTYWZhcmkuXG4gICAqIEBvdmVycmlkZVxuICAgKlxuICAgKiBAcGFyYW0ge2Jvb2xlYW59IGtlZXBQcmVmcyAtIFdoZXRoZXIgdG8ga2VlcCBTYWZhcmkgcHJlZmVyZW5jZXMgZnJvbSBiZWluZyBkZWxldGVkLlxuICAgKi9cbiAgYXN5bmMgY2xlYW5TYWZhcmkgKGtlZXBQcmVmcyA9IHRydWUpIHtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGVybWluYXRlKHRoaXMudWRpZCwgTU9CSUxFX1NBRkFSSV9CVU5ETEVfSUQpO1xuICAgIH0gY2F0Y2ggKGlnbikge1xuICAgICAgLy8gaWdub3JlIGVycm9yXG4gICAgfVxuICAgIGF3YWl0IHN1cGVyLmNsZWFuU2FmYXJpKGtlZXBQcmVmcyk7XG4gIH1cblxuICAvKipcbiAgICogQ2xlYW4vc2NydWIgdGhlIHBhcnRpY3VsYXIgYXBwbGljYXRpb24gb24gU2ltdWxhdG9yLlxuICAgKiBAb3ZlcnJpZGVcbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IGFwcEZpbGUgLSBBcHBsaWNhdGlvbiBuYW1lIG1pbnVzIFwiLmFwcFwiLlxuICAgKiBAcGFyYW0ge3N0cmluZ30gYXBwQnVuZGxlSWQgLSBCdW5kbGUgaWRlbnRpZmllciBvZiB0aGUgYXBwbGljYXRpb24uXG4gICAqIEBwYXJhbSB7Ym9vbGVhbn0gc2NydWIgLSBJZiBgc2NydWJgIGlzIGZhbHNlLCB3ZSB3YW50IHRvIGNsZWFuIGJ5IGRlbGV0aW5nIHRoZSBhcHAgYW5kIGFsbFxuICAgKiAgIGZpbGVzIGFzc29jaWF0ZWQgd2l0aCBpdC4gSWYgYHNjcnViYCBpcyB0cnVlLCB3ZSBqdXN0IHdhbnQgdG8gZGVsZXRlIHRoZSBwcmVmZXJlbmNlcyBhbmRcbiAgICogICBjaGFuZ2VkIGZpbGVzLlxuICAgKi9cbiAgYXN5bmMgY2xlYW5DdXN0b21BcHAgKGFwcEZpbGUsIGFwcEJ1bmRsZUlkLCBzY3J1YiA9IGZhbHNlKSB7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRlcm1pbmF0ZSh0aGlzLnVkaWQsIGFwcEJ1bmRsZUlkKTtcbiAgICB9IGNhdGNoIChpZ24pIHtcbiAgICAgIC8vIGlnbm9yZSBlcnJvclxuICAgIH1cbiAgICBhd2FpdCBzdXBlci5jbGVhbkN1c3RvbUFwcChhcHBGaWxlLCBhcHBCdW5kbGVJZCwgc2NydWIpO1xuICB9XG5cbiAgLyoqXG4gICAqIFBlcmZvcm0gU2hha2UgZ2VzdHVyZSBvbiBTaW11bGF0b3Igd2luZG93IHZpYSBBcHBsZVNjcmlwdC5cbiAgICovXG4gIGFzeW5jIHNoYWtlICgpIHtcbiAgICBhd2FpdCB0aGlzLmV4ZWN1dGVVSUNsaWVudFNjcmlwdChgXG4gICAgICB0ZWxsIGFwcGxpY2F0aW9uIFwiU3lzdGVtIEV2ZW50c1wiXG4gICAgICAgIHRlbGwgcHJvY2VzcyBcIlNpbXVsYXRvclwiXG4gICAgICAgICAga2V5c3Ryb2tlIFwielwiIHVzaW5nIHtjb250cm9sIGRvd24sIGNvbW1hbmQgZG93bn1cbiAgICAgICAgZW5kIHRlbGxcbiAgICAgIGVuZCB0ZWxsXG4gICAgYCk7XG4gIH1cblxuICAvKipcbiAgICogU2V0IGN1c3RvbSBnZW9sb2NhdGlvbiBwYXJhbWV0ZXJzIGZvciB0aGUgZ2l2ZW4gU2ltdWxhdG9yIHVzaW5nIEFwcGxlU2NyaXB0LlxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gbGF0aXR1ZGUgLSBUaGUgbGF0aXR1ZGUgdmFsdWUsIHdoaWNoIGlzIGdvaW5nIHRvIGJlIGVudGVyZWRcbiAgICogICBpbnRvIHRoZSBjb3JyZXNwb25kaW5nIGVkaXQgZmllbGQsIGZvciBleGFtcGxlICczOSwwMDA2Jy5cbiAgICogQHBhcmFtIHtzdHJpbmd9IGxvbmdpdHVkZSAtIFRoZSBsb25naXR1ZGUgdmFsdWUsIHdoaWNoIGlzIGdvaW5nIHRvIGJlIGVudGVyZWRcbiAgICogICBpbnRvIHRoZSBjb3JyZXNwb25kaW5nIGVkaXQgZmllbGQsIGZvciBleGFtcGxlICcxOSwwMDY4Jy5cbiAgICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgdGhlIGdpdmVuIHBhcmFtZXRlcnMgaGF2ZSBjb3JyZWN0IGZvcm1hdCBhbmQgd2VyZSBzdWNjZXNzZnVsbHkgYWNjZXB0ZWQuXG4gICAqL1xuICBhc3luYyBzZXRHZW9sb2NhdGlvbiAobGF0aXR1ZGUsIGxvbmdpdHVkZSkge1xuICAgIGNvbnN0IG91dHB1dCA9IGF3YWl0IHRoaXMuZXhlY3V0ZVVJQ2xpZW50U2NyaXB0KGBcbiAgICAgIHRlbGwgYXBwbGljYXRpb24gXCJTeXN0ZW0gRXZlbnRzXCJcbiAgICAgICAgdGVsbCBwcm9jZXNzIFwiU2ltdWxhdG9yXCJcbiAgICAgICAgICBzZXQgZmVhdHVyZU5hbWUgdG8gXCJDdXN0b20gTG9jYXRpb25cIlxuICAgICAgICAgIHNldCBkc3RNZW51SXRlbSB0byBtZW51IGl0ZW0gKGZlYXR1cmVOYW1lICYgXCLigKZcIikgb2YgbWVudSAxIG9mIG1lbnUgaXRlbSBcIkxvY2F0aW9uXCIgb2YgbWVudSAxIG9mIG1lbnUgYmFyIGl0ZW0gXCJEZWJ1Z1wiIG9mIG1lbnUgYmFyIDFcbiAgICAgICAgICBjbGljayBkc3RNZW51SXRlbVxuICAgICAgICAgIGRlbGF5IDFcbiAgICAgICAgICBzZXQgdmFsdWUgb2YgdGV4dCBmaWVsZCAxIG9mIHdpbmRvdyBmZWF0dXJlTmFtZSB0byBcIiR7bGF0aXR1ZGV9XCJcbiAgICAgICAgICBkZWxheSAwLjVcbiAgICAgICAgICBzZXQgdmFsdWUgb2YgdGV4dCBmaWVsZCAyIG9mIHdpbmRvdyBmZWF0dXJlTmFtZSB0byBcIiR7bG9uZ2l0dWRlfVwiXG4gICAgICAgICAgZGVsYXkgMC41XG4gICAgICAgICAgY2xpY2sgYnV0dG9uIFwiT0tcIiBvZiB3aW5kb3cgZmVhdHVyZU5hbWVcbiAgICAgICAgICBkZWxheSAwLjVcbiAgICAgICAgICBzZXQgaXNJbnZpc2libGUgdG8gKG5vdCAoZXhpc3RzICh3aW5kb3cgZmVhdHVyZU5hbWUpKSlcbiAgICAgICAgZW5kIHRlbGxcbiAgICAgIGVuZCB0ZWxsXG4gICAgYCk7XG4gICAgbG9nLmRlYnVnKGBHZW9sb2NhdGlvbiBwYXJhbWV0ZXJzIGRpYWxvZyBhY2NlcHRlZDogJHtvdXRwdXR9YCk7XG4gICAgcmV0dXJuIF8uaXNTdHJpbmcob3V0cHV0KSAmJiBvdXRwdXQudHJpbSgpID09PSAndHJ1ZSc7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgU2ltdWxhdG9yWGNvZGU4O1xuIl0sInNvdXJjZVJvb3QiOiIuLi8uLiJ9
